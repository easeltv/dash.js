<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>ThePlatform Smooth Streaming + PlayReady example</title>
<!--   <script src="http://192.168.2.100:8081/target/target-script-min.js#anonymous"></script>
 -->

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.20/lodash.min.js"></script>
  <script src="../../dist/dash.all.debug.js"></script>
  <!--dash.all.min.js should be used in production over dash.all.debug.js
    Debug files are not compressed or obfuscated making the file size much larger compared with dash.all.min.js-->
  <!--<script src="../../dist/dash.all.min.js"></script>-->
  <!-- add mss package which is required to play Smooth Streaming streams -->
  <script class="code" src="../../dist/dash.mss.debug.js"></script>

  <script class="code">

    // save time, populate these
    var defaults = {
      licenseServer: "http://playready.entitlement.theplatform.eu/playready/rightsmanager.asmx",
      mpxToken: "",
      mediaUrl: "",
      accountId: "http://access.auth.theplatform.com/data/Account/2669535363",
      autoLoad: false
    };

    var query = _(location.search.substr(1)).split("&").map(function(x) { return x.split("="); })
      .fromPairs().transform(function(r, v, k) { r[k] = decodeURIComponent(v); }).value();
    defaults = _.merge(defaults, query);

    function populateDefaults() {
      $("#licenseserver").val(defaults.licenseServer);
      $("#mpxtoken").val(defaults.mpxToken);
      $("#mediaurl").val(defaults.mediaUrl);
      $("#accountid").val(defaults.accountId);
    }

    function fetchStreamData() {
      var mpxToken = $("#mpxtoken").val();
      var mediaUrl = $("#mediaurl").val();

      var url = mediaUrl + "?format=smil&formats=ism&manifest=ism&tracking=true&clientId=prtest"
        + "&token=" + encodeURIComponent(mpxToken);
      $.ajax({url: url, dataType: "xml"}).done(function(xml) {
        var $xml = $(xml);
        var trackingData = $xml.find("ref").find("param[name=trackingData]").attr("value");
        var releasePid = trackingData ? _.last(trackingData.match(/\|pid=(.*?)\|/)) : "";
        var streamUrl = $xml.find("video").attr("src");
        var customData = ["schema=1.0", "auth=" + mpxToken,
          "account=" + $("#accountid").val(), "releasePid=" + releasePid].join(" ");

       // docker run -d -p 8080:8080 --name cors-anywhere redocly/cors-anywhere
       //init("http://" + location.hostname + ":8080/" + streamUrl, customData);
       init(streamUrl, customData);
      });
    }

    function init(streamUrl, customData) {
      console.log("Initialising player with url", streamUrl, "customData", customData);
      const protData = {
        "com.microsoft.playready": {
          "serverURL": $("#licenseserver").val(),
          "cdmData": customData
         }
      };

      var video = document.querySelector("video");
      var player = dashjs.MediaPlayer().create();
      player.initialize(video, streamUrl, true);
      if (protData["com.microsoft.playready"].serverURL) {
        player.setProtectionData(protData);
      }
      window.player = player;
    }
  </script>

  <style>
    body {
      background-color: #fff;
    }
    video {
      width: 640px;
      height: 360px;
    }
  </style>
</head>
<body>
<div>
  <video controls="true">
  </video>
</div>

<div>
  <form>
    <label for="licenseserver">License server:</label><br>
    <input type="text" id="licenseserver" name="licenseserver" value="" size="90"><br>
    <label for="accountid">Account ID:</label><br>
    <input type="text" id="accountid" name="accountid" value="" size="90"><br>
    <label for="mpxtoken">MPX token:</label><br>
    <input type="text" id="mpxtoken" name="mpxtoken" value="" size="90"><br>
    <label for="mediaurl">Media URL:</label><br>
    <input type="text" id="mediaurl" name="mediaurl" value="" size="90"><br><br>
    <input type="button" id="load" value="&gt;&gt; Load vid &lt;&lt;">
  </form>
</div>

<script>
  /*
    keydown Down 40 Down
    keydown Up 38 Up
    keydown Left 37 Left
    keydown Right 39 Right
    keydown MediaPlayPause 179 MediaPlayPause
    keydown MediaRewind 227 MediaRewind
    keydown MediaFastForward 228 MediaFastForward
    keydown 1 49 U+0031
    keydown 2 50 U+0032
    keydown 3 51 U+0033
  */  
  document.addEventListener('keydown', function(ev) {
    console.log('keydown', ev.key, ev.keyCode, ev.code)
    var handled = true;
    switch (ev.key) {
      case "MediaPlayPause":
        if (player) {
          player.isPaused() ? player.play() : player.pause();
        }
        break;
      case "MediaRewind":
        try {
          player.seek(player.time() - 60);
        } catch (err) {
          console.log("seek err", err);
        }
        break;
      case "MediaFastForward":
        try {
          player.seek(player.time() + 60);
        } catch (err) {
          console.log("seek err", err);
        }
        break;
      case "Escape":
        history.back();
        break;
      case "1":
        window.location.reload(true);
        break;
      case "Up":
      case "Down":
      case "Left":
      case "Right":
      case "2":
      case "3":
      case "4":
      default:
        handled = false;
    }
    return handled
  }, false);

  document.addEventListener("DOMContentLoaded", function () {
    console.log("------------------DOMContentLoaded-----------------");
    populateDefaults()
    $("#load").click(fetchStreamData);
    if (defaults.autoLoad) {
      fetchStreamData();
    }
  });
</script>
<!--
<script src="../highlighter.js"></script>
-->
</body>
</html>


